<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>HSTC Trainer</title>

  <!-- Grund-Styles -->
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#0b1220; --muted:#667085;
      --brand:#1a73e8; --border:#e5e7ef; --radius:14px; --pad:14px;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:0 1px 4px rgba(0,0,0,.04)}
    h1,h2,h3{margin:8px 0 10px}
    label{font-size:14px;color:#334155}
    input,select,button{font-size:16px}
    input,select{padding:8px;border:1px solid #d7dbe7;border-radius:10px;background:#fff}
    button{padding:10px 14px;border-radius:10px;border:1px solid #cdd3e0;background:#fff;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .center{text-align:center}
    .muted{color:var(--muted);font-size:14px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
    .home-grid{display:grid;gap:12px;grid-template-columns:1fr;max-width:560px;margin:24px auto}
    .home-grid button{padding:16px 18px;font-weight:600}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .tabs-inline{display:inline-flex;border:1px solid #d7dbe7;border-radius:999px;overflow:hidden}
    .tabs-inline button{border:0;border-right:1px solid #d7dbe7;background:#f3f4f8;padding:8px 12px}
    .tabs-inline button:last-child{border-right:0}
    .tabs-inline button.active{background:#1e293b;color:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:700px){.grid2,.grid3{grid-template-columns:1fr}}

    /* Matrix */
    .matrix-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
    table.matrix{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
    table.matrix th, table.matrix td{border-bottom:1px solid #eee;border-right:1px solid #eee;padding:8px 10px;text-align:center;white-space:nowrap}
    table.matrix thead th{position:sticky;top:0;background:#0f172a;color:#e5e7eb;z-index:2}
    table.matrix th:first-child{position:sticky;left:0;background:#0f172a;color:#e5e7eb;z-index:3}
    table.matrix td:first-child{position:sticky;left:0;background:#f8fafc;z-index:1;text-align:left}

    .dot{display:inline-block;width:18px;height:18px;border-radius:50%}
    .r1{background:#1e40af}.r2{background:#16a34a}.r3{background:#eab308}.r4{background:#f59e0b}.r5{background:#ef4444}
    .rating-pick .dot{margin-right:6px;border:2px solid transparent;cursor:pointer}
    .rating-pick .dot.sel{outline:2px solid #0ea5e9;outline-offset:1px}
    .note-btn{margin-left:8px;font-size:14px;padding:4px 8px}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi .card{padding:12px}
    @media (max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.kpi{grid-template-columns:1fr}}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0a7;color:#fff;padding:10px 14px;border-radius:10px;display:none}
    .danger{background:#b00020}
  </style>

  <!-- Chart.js + Date-Adapter (für Zeitachse) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="screen-login" class="card" style="max-width:520px;margin:40px auto">
      <h2 class="center">Anmelden</h2>
      <div class="row">
        <label style="flex:1">E-Mail
          <input id="email" type="email" placeholder="du@beispiel.de" style="width:100%">
        </label>
        <label style="flex:1">Passwort
          <input id="password" type="password" placeholder="••••••••" style="width:100%">
        </label>
      </div>
      <div class="row center mt12" style="justify-content:center">
        <button id="login-btn" class="primary">Anmelden</button>
        <button id="signup-btn">Registrieren</button>
      </div>
      <div id="login-msg" class="muted center mt8"></div>
    </div>

    <!-- HOME -->
    <div id="screen-home" class="hidden">
      <div class="card">
        <div class="topbar">
          <h2 id="welcome-name">Willkommen</h2>
          <div class="top-actions">
            <span class="muted" id="whoami"></span>
            <button id="logout-btn">Abmelden</button>
          </div>
        </div>
        <div class="home-grid">
          <button id="go-overview" class="primary">Übersicht</button>
          <button id="go-training" class="primary">Training</button>
          <button id="go-team" class="primary hidden">Team (Admin)</button>
          <button id="go-admin" class="primary hidden">Verwaltung (Admin)</button>
        </div>
      </div>
    </div>

    <!-- HEADER IN SCREENS -->
    <div id="screen-header" class="hidden">
      <div class="card topbar">
        <h2 id="screen-title">—</h2>
        <div class="top-actions">
          <button id="btn-home">Home</button>
        </div>
      </div>
    </div>

    <!-- ÜBERSICHT -->
    <div id="screen-overview" class="hidden">
      <div class="card">
        <h3>Filter</h3>
        <div class="grid3">
          <label>Hund
            <select id="ov-dog" style="width:100%"></select>
          </label>
          <label>Kategorie
            <select id="ov-cat" style="width:100%"></select>
          </label>
          <label>Ab Datum
            <input id="ov-from" type="date" style="width:100%">
          </label>
        </div>
        <div class="grid2 mt12">
          <label>Übung
            <select id="ov-ex" style="width:100%">
              <option value="all">Alle</option>
            </select>
          </label>
          <div>
            <div class="tabs-inline">
              <button id="mode-eb" class="active" type="button">EB</button>
              <button id="mode-tb" type="button">TB</button>
              <button id="mode-both" type="button">Beide</button>
            </div>
            <div class="tabs-inline mt8">
              <button id="tab-table" class="active" type="button">Tabelle</button>
              <button id="tab-stats" type="button">Statistik</button>
            </div>
            <button id="ov-load" class="primary" style="margin-left:8px">Laden</button>
          </div>
        </div>
      </div>

      <!-- Tabelle -->
      <div id="ov-view-table" class="mt16">
        <div class="matrix-wrap">
          <table class="matrix" id="ov-matrix">
            <thead id="ov-head"></thead>
            <tbody id="ov-body"></tbody>
          </table>
        </div>
        <div class="muted mt8">Tipp auf eine Zelle zeigt die Notiz (falls vorhanden).</div>
      </div>

      <!-- Statistik -->
      <div id="ov-view-stats" class="hidden mt16">
        <div class="kpi">
          <div class="card"><div class="muted">Anz. Trainings</div><div id="kpi-trainings" style="font-size:22px;font-weight:700">–</div></div>
          <div class="card"><div class="muted">Anz. Übungen</div><div id="kpi-entries" style="font-size:22px;font-weight:700">–</div></div>
          <div class="card"><div class="muted">Ø Kategorie (EB/TB)</div><div id="kpi-avg-cat" style="font-size:22px;font-weight:700">–</div></div>
          <div class="card"><div class="muted">Ø Übung (EB/TB)</div><div id="kpi-avg-ex" style="font-size:22px;font-weight:700">–</div></div>
        </div>

        <div class="card mt16">
          <h3>Verlauf (EB & TB)</h3>
          <canvas id="chart-line" height="240"></canvas>
          <div class="muted mt8">Punkt klicken: unten erscheint die Tabelle dieses Trainings; bei einzelner Übung erscheint (falls vorhanden) direkt die Notiz.</div>
        </div>

        <div class="card mt16">
          <h3>Selten/Alt/Schwach</h3>
          <div id="stats-rare" class="mt8"></div>
        </div>

        <div class="card mt16">
          <h3>Details zum gewählten Trainingstag</h3>
          <table class="matrix" id="ov-train-table" style="min-width:100%">
            <thead><tr><th>Übung</th><th>EB</th><th>TB</th><th>Notiz</th></tr></thead>
            <tbody id="ov-train-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TRAINING -->
    <div id="screen-training" class="hidden">
      <div class="card">
        <h3>Neue Session</h3>
        <div class="grid3">
          <label>Hund
            <select id="tr-dog" style="width:100%"></select>
          </label>
          <label>Datum
            <input id="tr-date" type="date" style="width:100%">
          </label>
          <label>Kategorie
            <select id="tr-cat" style="width:100%"></select>
          </label>
        </div>
      </div>

      <div class="card mt16">
        <h3>Übungen</h3>
        <div id="tr-exlist" class="row" style="align-items:flex-start"></div>
        <div class="mt12 center">
          <button id="tr-save" class="primary">Session speichern</button>
          <span id="tr-msg" class="muted" style="margin-left:8px"></span>
        </div>
      </div>
    </div>

    <!-- TEAM (Admin) -->
    <div id="screen-team" class="hidden">
      <div class="card">
        <h3>Team-Filter</h3>
        <div class="grid3">
          <label>Hundeführer
            <select id="tm-handler" style="width:100%"></select>
          </label>
          <label>Hund
            <select id="tm-dog" style="width:100%"><option value="all">Alle</option></select>
          </label>
          <label>Ab Datum
            <input id="tm-from" type="date" style="width:100%">
          </label>
        </div>
        <div class="grid2 mt12">
          <label>Kategorie
            <select id="tm-cat" style="width:100%"></select>
          </label>
          <label>Übung
            <select id="tm-ex" style="width:100%"><option value="all">Alle</option></select>
          </label>
        </div>
        <div class="mt12">
          <button id="tm-load" class="primary">Übersicht laden</button>
        </div>
      </div>

      <div class="card mt16">
        <div class="matrix-wrap mt12">
          <table class="matrix" id="tm-table"><thead id="tm-head"></thead><tbody id="tm-body"></tbody></table>
        </div>
      </div>
    </div>

    <!-- VERWALTUNG (Admin) -->
    <div id="screen-admin" class="hidden">
      <div class="card">
        <h3>Person anlegen (Einladung per E-Mail)</h3>
        <div class="grid3">
          <label>Vorname <input id="ad-first" type="text"></label>
          <label>Nachname <input id="ad-last" type="text"></label>
          <label>E-Mail   <input id="ad-email" type="email"></label>
        </div>
        <div class="mt12">
          <button id="ad-invite" class="primary">Einladung senden</button>
          <span id="ad-msg" class="muted"></span>
        </div>
      </div>

      <div class="card mt16">
        <h3>Hunde verwalten</h3>
        <div class="row">
          <label>Name <input id="ad-dog-name" type="text"></label>
          <label>Rasse <input id="ad-dog-breed" type="text"></label>
          <button id="ad-dog-add" class="primary">Hund hinzufügen</button>
        </div>
        <ul id="ad-dog-list" class="mt12"></ul>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- App-Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Supabase ===
    const sb = createClient(
      'https://vtollmxfgurqxorbodad.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0b2xsbXhmZ3VycXhvcmJvZGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMzM5ODcsImV4cCI6MjA3MjkwOTk4N30.FmmOU2pST4YPKeiRcFSDugMLgXuCPxGOKuxidjnu-w0',
      { db: { schema: 'app' } }
    );

    // === Helpers/UI ===
    const $ = (q)=>document.querySelector(q);
    const show = (sel)=>$(sel).classList.remove('hidden');
    const hide = (sel)=>$(sel).classList.add('hidden');
    const toast = (t, ok=true)=>{ const el=$('#toast'); el.textContent=t; el.classList.toggle('danger', !ok); el.style.display='block'; setTimeout(()=>el.style.display='none', 2000); };
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const COLORS = {1:'r1',2:'r2',3:'r3',4:'r4',5:'r5'};
    let profile=null, cats=[], exercises=[], dogs=[], people=[], sessionsCache=[];
    let lineChart=null, ratingMode='eb'; // 'eb' | 'tb' | 'both'

    function lock(btn, locked=true){ if(!btn) return; btn.disabled=locked; if(locked) btn.dataset.lock='1'; else delete btn.dataset.lock; }

    // NAV
    function goHome(){
      ['#screen-overview','#screen-training','#screen-team','#screen-admin','#screen-header'].forEach(hide);
      show('#screen-home');
    }
    function openScreen(title, id){
      $('#screen-title').textContent = title;
      hide('#screen-home'); show('#screen-header');
      ['#screen-overview','#screen-training','#screen-team','#screen-admin'].forEach(hide);
      show(id);
    }

    // AUTH
    $('#login-btn').addEventListener('click', async ()=>{
      lock($('#login-btn'), true);
      const email=$('#email').value.trim(), password=$('#password').value;
      $('#login-msg').textContent='';
      const { error } = await sb.auth.signInWithPassword({ email, password });
      lock($('#login-btn'), false);
      if(error){ $('#login-msg').textContent='Fehler: '+error.message; return; }
      await afterLogin();
    });
    $('#signup-btn').addEventListener('click', async ()=>{
      lock($('#signup-btn'), true);
      const email=$('#email').value.trim(), password=$('#password').value;
      const { error } = await sb.auth.signUp({ email, password });
      lock($('#signup-btn'), false);
      if(error){ $('#login-msg').textContent='Fehler: '+error.message; return; }
      $('#login-msg').textContent='Registrierung ok – E-Mail prüfen.';
    });
    $('#logout-btn').addEventListener('click', async ()=>{
      await sb.auth.signOut(); profile=null; goLogin();
    });
    function goLogin(){
      ['#screen-home','#screen-header','#screen-overview','#screen-training','#screen-team','#screen-admin'].forEach(hide);
      show('#screen-login');
      $('#email').value=''; $('#password').value='';
    }

    // AFTER LOGIN
    async function afterLogin(){
      const { data:ud } = await sb.auth.getUser();
      const uid = ud?.user?.id;
      if(!uid){ goLogin(); return; }

      // Profil laden
      let prof=null;
      try {
        const { data } = await sb.from('profiles').select('user_id, club_id, role, display_name').eq('user_id', uid).single();
        prof=data;
      } catch(e) {}

      profile = prof || { user_id: uid, role: 'user', display_name: (ud?.user?.email||'').split('@')[0] };

      const [{data:cat},{data:ex},{data:dg},{data:pp}] = await Promise.all([
        sb.from('exercise_categories').select('id,name').order('name'),
        sb.from('exercises').select('id,name,category_id').order('name'),
        sb.from('dogs').select('id,name,breed').order('name'),
        sb.from('people').select('id,first_name,last_name').order('first_name')
      ]);
      cats=cat||[]; exercises=ex||[]; dogs=dg||[]; people=pp||[];

      $('#whoami').textContent = ud?.user?.email || '';
      const firstname = (profile?.display_name || ud?.user?.email?.split('@')[0] || 'User').split(' ')[0];
      $('#welcome-name').textContent = firstname;

      // Admin Buttons
      const isAdmin = profile?.role==='admin' || profile?.role==='trainer';
      $('#go-team').classList.toggle('hidden', !isAdmin);
      $('#go-admin').classList.toggle('hidden', profile?.role!=='admin');

      // Fill selects defaults
      fillSel($('#ov-cat'), cats);
      setDate($('#ov-from'), todayStr());
      fillSel($('#tr-cat'), cats);
      setDate($('#tr-date'), todayStr());
      fillSel($('#ov-dog'), dogs); fillSel($('#tr-dog'), dogs);
      rebuildOverviewExerciseSelect(); rebuildTrainingExerciseList();

      // Team filters
      fillSel($('#tm-cat'), cats);
      setDate($('#tm-from'), todayStr());
      fillSel($('#tm-handler'), people, 'id', p=>`${p.first_name} ${p.last_name}`);
      $('#tm-dog').innerHTML = '<option value="all">Alle</option>';

      // Switch to Home
      hide('#screen-login'); show('#screen-home');
    }

    function setDate(inp, v){ if(inp) inp.value=v; }
    function fillSel(sel, items, value='id', label='name'){
      if(!sel) return;
      const lab = (typeof label==='function') ? label : (x)=>x[label];
      sel.innerHTML = (items||[]).map(i=>`<option value="${i[value]}">${lab(i)}</option>`).join('');
    }

    // SESSION RESUME
    sb.auth.getSession().then(async ({data})=>{
      if(data?.session) await afterLogin(); else goLogin();
    });

    // HOME NAV
    $('#go-overview').addEventListener('click', ()=>{ openScreen('Übersicht', '#screen-overview'); });
    $('#go-training').addEventListener('click', ()=>{ openScreen('Training',  '#screen-training'); });
    $('#go-team').addEventListener('click',     ()=>{ openScreen('Team',      '#screen-team'); });
    $('#go-admin').addEventListener('click',    ()=>{ openScreen('Verwaltung','#screen-admin'); });
    $('#btn-home').addEventListener('click', goHome);

    // ========= ÜBERSICHT =========
    function rebuildOverviewExerciseSelect(){
      const catId = Number($('#ov-cat').value||0);
      const list = exercises.filter(e=>!catId || e.category_id===catId);
      $('#ov-ex').innerHTML = '<option value="all">Alle</option>'+ list.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    }
    $('#ov-cat').addEventListener('change', rebuildOverviewExerciseSelect);

    // EB/TB Umschalter
    const ebBtn=$('#mode-eb'), tbBtn=$('#mode-tb'), bothBtn=$('#mode-both');
    [ebBtn, tbBtn, bothBtn].forEach(btn=>{
      btn?.addEventListener('click', ()=>{
        [ebBtn,tbBtn,bothBtn].forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        ratingMode = (btn===ebBtn) ? 'eb' : (btn===tbBtn ? 'tb' : 'both');
      });
    });

    // Toggle Tabelle/Statistik
    $('#tab-table').addEventListener('click', ()=>{ $('#tab-table').classList.add('active'); $('#tab-stats').classList.remove('active'); show('#ov-view-table'); hide('#ov-view-stats'); });
    $('#tab-stats').addEventListener('click', ()=>{ $('#tab-stats').classList.add('active'); $('#tab-table').classList.remove('active'); hide('#ov-view-table'); show('#ov-view-stats'); });

    // Laden
    $('#ov-load').addEventListener('click', async ()=>{
      const dogId = $('#ov-dog').value;
      const catId = Number($('#ov-cat').value||0);
      const from  = $('#ov-from').value || todayStr();
      const exFilter = $('#ov-ex').value; // 'all' oder id

      if(!dogId){ toast('Bitte Hund wählen', false); return; }

      lock($('#ov-load'), true);
      const { data:sessions, error } = await sb
        .from('sessions').select('id,session_date,entries_json,dog_id')
        .eq('dog_id', dogId).gte('session_date', from)
        .order('session_date', { ascending: true }).limit(1000);
      lock($('#ov-load'), false);
      if(error){ toast('Fehler: '+error.message, false); return; }

      sessionsCache = sessions||[];

      const exById = new Map(exercises.map(e=>[e.id,e]));
      const rows = [];
      (sessions||[]).forEach(s=>{
        (s.entries_json||[]).forEach(en=>{
          const ex = exById.get(en.exercise_id); if(!ex) return;
          if(catId && ex.category_id!==catId) return;
          if(exFilter!=='all' && String(en.exercise_id)!==exFilter) return;
          rows.push({
            session_id:s.id, date:s.session_date,
            exercise_id:en.exercise_id, exercise_name:ex.name,
            eb: (en.eb ?? null), tb: (en.tb ?? null), note: en.note||''
          });
        });
      });

      buildMatrix(rows);
      buildStats(rows, sessions, { exFilter, catId });
    });

    function buildMatrix(rows){
      const valueKey = (ratingMode === 'tb') ? 'tb' : 'eb'; // 'both' -> wir zeigen EB
      const dates = [...new Set(rows.map(r=>r.date))];
      const exs   = [...new Set(rows.map(r=>r.exercise_name))];
      const head=$('#ov-head'), body=$('#ov-body');
      head.innerHTML = '<tr><th>Datum</th>'+ exs.map(n=>`<th>${n}</th>`).join('') + '</tr>';
      body.innerHTML = dates.map(d=>{
        const cells = exs.map(name=>{
          const r = rows.find(x=>x.date===d && x.exercise_name===name);
          if(!r) return '<td></td>';
          const val = r[valueKey];
          if(!val) return '<td></td>';
          const cls = COLORS[val]||'';
          const title = r.note ? `title="${r.note.replace(/"/g,'&quot;')}"` : '';
          return `<td data-note="${r.note? r.note.replace(/"/g,'&quot;'):''}"><span class="dot ${cls}" ${title}></span></td>`;
        }).join('');
        return `<tr><td>${new Date(d).toLocaleDateString('de-AT')}</td>${cells}</tr>`;
      }).join('');
      // Notiz-Klick
      $('#ov-body').querySelectorAll('td').forEach(td=>{
        td.addEventListener('click', ()=>{
          const note = td.getAttribute('data-note'); if(note) alert(note);
        });
      });
    }

    function average(arr){ return arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null; }

    function buildStats(rows, sessions, { exFilter, catId }){
      // KPIs
      const trainDates = [...new Set((sessions||[]).map(s=>s.session_date))];
      $('#kpi-trainings').textContent = String(trainDates.length);
      $('#kpi-entries').textContent   = String(rows.length);

      const ebVals = rows.map(r=>r.eb).filter(v=>v!=null);
      const tbVals = rows.map(r=>r.tb).filter(v=>v!=null);
      const avgCatEB = average(ebVals), avgCatTB = average(tbVals);
      $('#kpi-avg-cat').textContent = [
        avgCatEB!=null ? `EB ${avgCatEB.toFixed(2)}` : 'EB –',
        avgCatTB!=null ? ` / TB ${avgCatTB.toFixed(2)}` : ' / TB –'
      ].join('');

      if (exFilter !== 'all') {
        const ebOne = rows.filter(r=>String(r.exercise_id)===exFilter).map(r=>r.eb).filter(v=>v!=null);
        const tbOne = rows.filter(r=>String(r.exercise_id)===exFilter).map(r=>r.tb).filter(v=>v!=null);
        const aEB = average(ebOne), aTB = average(tbOne);
        $('#kpi-avg-ex').textContent = [
          aEB!=null ? `EB ${aEB.toFixed(2)}` : 'EB –',
          aTB!=null ? ` / TB ${aTB.toFixed(2)}` : ' / TB –'
        ].join('');
      } else {
        $('#kpi-avg-ex').textContent = '–';
      }

      // selten / alt / schwach (TB bevorzugt, sonst EB)
      const byEx = new Map();
      rows.forEach(r=>{
        if(!byEx.has(r.exercise_name)) byEx.set(r.exercise_name,{count:0,last:null,eb:[],tb:[]});
        const o = byEx.get(r.exercise_name);
        o.count++; o.last = r.date;
        if(r.eb!=null) o.eb.push(r.eb);
        if(r.tb!=null) o.tb.push(r.tb);
      });
      const arr = [...byEx.entries()].map(([name,v])=>({
        name, count:v.count, last:v.last,
        avgEB: v.eb.length ? average(v.eb) : null,
        avgTB: v.tb.length ? average(v.tb) : null
      }));
      const rare = arr.length? arr.slice().sort((a,b)=>a.count-b.count)[0]:null;
      const old  = arr.length? arr.slice().sort((a,b)=> new Date(a.last)-new Date(b.last))[0]:null;
      const weak = arr.length? arr.slice().sort((a,b)=>{
        const ax = a.avgTB ?? a.avgEB ?? 9;
        const bx = b.avgTB ?? b.avgEB ?? 9;
        return ax - bx;
      })[0]:null;
      $('#stats-rare').innerHTML = `
        <div><strong>Seltenste Übung:</strong> ${rare? `${rare.name} (${rare.count}×)`: '–'}</div>
        <div><strong>Am längsten nicht gemacht:</strong> ${old? `${old.name} (seit ${new Date(old.last).toLocaleDateString('de-AT')})`:'–'}</div>
        <div><strong>Schlechteste Übung:</strong> ${weak? `${weak.name} (Ø ${(weak.avgTB ?? weak.avgEB).toFixed(2)})`:'–'}</div>
      `;

      // Chart-Daten (zwei Datensätze EB/TB)
      let dsEB=[], dsTB=[];
      if (exFilter!=='all') {
        const rowsOne = rows.filter(r=>String(r.exercise_id)===exFilter);
        rowsOne.forEach(r=>{
          if(r.eb!=null) dsEB.push({ x:new Date(r.date), y:r.eb, session_id:r.session_id, note:r.note, exercise_id:r.exercise_id, exercise_name:r.exercise_name });
          if(r.tb!=null) dsTB.push({ x:new Date(r.date), y:r.tb, session_id:r.session_id, note:r.note, exercise_id:r.exercise_id, exercise_name:r.exercise_name });
        });
      } else {
        const byDateEB = new Map(), byDateTB = new Map();
        rows.forEach(r=>{
          const d=r.date;
          if(r.eb!=null){ if(!byDateEB.has(d)) byDateEB.set(d,[]); byDateEB.get(d).push(r.eb); }
          if(r.tb!=null){ if(!byDateTB.has(d)) byDateTB.set(d,[]); byDateTB.get(d).push(r.tb); }
        });
        [...byDateEB.entries()].forEach(([d,vals])=> dsEB.push({ x:new Date(d), y:average(vals), date:d }));
        [...byDateTB.entries()].forEach(([d,vals])=> dsTB.push({ x:new Date(d), y:average(vals), date:d }));
      }

      renderLineChartDual(dsEB, dsTB);

      // Klick auf Punkt -> unten Tabelle/Notiz
      lineChart.options.onClick = (_, elements)=>{
        if(!elements.length) return;
        const el = elements[0];
        const dataset = lineChart.data.datasets[el.datasetIndex];
        const dp = dataset.data[el.index];
        renderTrainingTable(dp.session_id, exFilter!=='all', exFilter);
        $('#ov-train-table').scrollIntoView({ behavior:'smooth', block:'start' });
      };
      lineChart.update();
    }

    function renderLineChartDual(dsEB, dsTB){
      const ctx = document.getElementById('chart-line').getContext('2d');
      if(lineChart) lineChart.destroy();
      lineChart = new window.Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            { label:'EB', data: dsEB, parsing:false, spanGaps:true, pointRadius:4, tension:0.25 },
            { label:'TB', data: dsTB, parsing:false, spanGaps:true, pointRadius:4, tension:0.25 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales: {
            x:{ type:'time', time:{ unit:'day' } },
            y:{ suggestedMin:1, suggestedMax:5, ticks:{ stepSize:1 } }
          },
          plugins: {
            legend:{ position:'top' },
            tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.dataset.label}: ${typeof ctx.raw.y==='number' ? ctx.raw.y.toFixed(2) : ctx.raw.y}` } }
          }
        }
      });
    }

    function renderTrainingTable(sessionId, singleExercise, exFilter){
      const s = (sessionsCache||[]).find(x=>x.id===sessionId);
      const tbody = $('#ov-train-body');
      tbody.innerHTML='';
      if(!s){ tbody.innerHTML='<tr><td colspan="4">(keine Daten)</td></tr>'; return; }
      const exById = new Map(exercises.map(e=>[e.id,e.name]));
      (s.entries_json||[]).forEach(en=>{
        const name = exById.get(en.exercise_id)||('Übung '+en.exercise_id);
        const note = en.note||'';
        const eb = en.eb ?? '—'; const tb = en.tb ?? '—';
        tbody.insertAdjacentHTML('beforeend', `<tr><td>${name}</td><td>${eb}</td><td>${tb}</td><td>${note? note.replace(/</g,'&lt;'):'—'}</td></tr>`);
      });
      if(singleExercise){
        const en = (s.entries_json||[]).find(e=> String(e.exercise_id)===String(exFilter));
        if(en?.note) alert(en.note);
      }
    }

    // ========= TRAINING =========
    function rebuildTrainingExerciseList(){
      const canTB = profile?.role === 'admin' || profile?.role === 'trainer';
      const catId = Number($('#tr-cat').value||0);
      const list = exercises.filter(e=>!catId || e.category_id===catId);
      const wrap = $('#tr-exlist'); wrap.innerHTML='';
      list.forEach(ex=>{
        const block = document.createElement('div');
        block.className='card'; block.style.width='330px';
        block.innerHTML = `
          <div style="font-weight:600;margin-bottom:6px">${ex.name}</div>

          <div class="muted" style="margin-bottom:4px">Eigenbewertung</div>
          <div class="rating-pick" data-ex="${ex.id}" data-type="eb">
            <span class="dot r1" data-v="1" title="1"></span>
            <span class="dot r2" data-v="2" title="2"></span>
            <span class="dot r3" data-v="3" title="3"></span>
            <span class="dot r4" data-v="4" title="4"></span>
            <span class="dot r5" data-v="5" title="5"></span>
          </div>

          ${canTB ? `
          <div class="muted" style="margin:8px 0 4px">Trainerbewertung</div>
          <div class="rating-pick" data-ex="${ex.id}" data-type="tb">
            <span class="dot r1" data-v="1" title="1"></span>
            <span class="dot r2" data-v="2" title="2"></span>
            <span class="dot r3" data-v="3" title="3"></span>
            <span class="dot r4" data-v="4" title="4"></span>
            <span class="dot r5" data-v="5" title="5"></span>
          </div>
          `:''}

          <div class="mt8">
            <button class="note-btn" data-ex="${ex.id}" type="button">+ Notiz</button>
            <input class="note-input hidden" data-ex="${ex.id}" type="text" placeholder="Notiz" style="width:100%;margin-top:8px">
          </div>
        `;
        wrap.appendChild(block);
      });
      wrap.querySelectorAll('.rating-pick .dot').forEach(dot=>{
        dot.addEventListener('click', ()=>{
          const p=dot.parentElement; p.querySelectorAll('.dot').forEach(d=>d.classList.remove('sel')); dot.classList.add('sel');
        });
      });
      wrap.querySelectorAll('.note-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.getAttribute('data-ex'); const input=wrap.querySelector(`.note-input[data-ex="${id}"]`);
          if(input) input.classList.toggle('hidden');
        });
      });
    }
    $('#tr-cat').addEventListener('change', rebuildTrainingExerciseList);

    $('#tr-save').addEventListener('click', async ()=>{
      const dogId=$('#tr-dog').value, date=$('#tr-date').value||todayStr();
      if(!dogId){ toast('Bitte Hund wählen', false); return; }
      const entriesMap = new Map(); // exercise_id -> {eb?, tb?, note?}
      $('#tr-exlist').querySelectorAll('.rating-pick').forEach(p=>{
        const exId=Number(p.getAttribute('data-ex'));
        const type=p.getAttribute('data-type'); // 'eb' | 'tb'
        const sel=p.querySelector('.dot.sel'); if(!sel) return;
        const rating=Number(sel.getAttribute('data-v'));
        if(!entriesMap.has(exId)) entriesMap.set(exId,{});
        entriesMap.get(exId)[type]=rating;
      });
      $('#tr-exlist').querySelectorAll('.note-input').forEach(i=>{
        if(i.classList.contains('hidden')) return;
        const exId=Number(i.getAttribute('data-ex'));
        if(!entriesMap.has(exId)) entriesMap.set(exId,{});
        const val=i.value.trim(); if(val) entriesMap.get(exId).note=val;
      });
      const entries=[...entriesMap.entries()].map(([exercise_id,o])=>({
        exercise_id,
        eb: Number.isFinite(o.eb)? o.eb : null,
        tb: Number.isFinite(o.tb)? o.tb : null,
        note: o.note ?? null
      }));
      if(!entries.length){ toast('Bitte mindestens eine Bewertung setzen', false); return; }

      lock($('#tr-save'), true);
      const { error } = await sb.from('sessions').insert({
        dog_id: dogId, session_date: date, entries_json: entries, notes: null, location: null
      });
      lock($('#tr-save'), false);
      if(error){ toast('Fehler: '+error.message, false); return; }
      toast('Session gespeichert');
      // Reset
      $('#tr-exlist').querySelectorAll('.dot.sel').forEach(d=>d.classList.remove('sel'));
      $('#tr-exlist').querySelectorAll('.note-input').forEach(i=>{ i.value=''; i.classList.add('hidden'); });
    });

    // ========= TEAM (Admin) =========
    $('#tm-handler').addEventListener('change', async ()=>{
      // Optional: Hunde des Handlers laden (hier simple: alle Hunde)
      fillSel($('#tm-dog'), [{id:'all', name:'Alle'}, ...dogs], 'id', 'name');
    });
    $('#tm-cat').addEventListener('change', ()=>{
      const catId = Number($('#tm-cat').value||0);
      const list = exercises.filter(e=>!catId || e.category_id===catId);
      $('#tm-ex').innerHTML = '<option value="all">Alle</option>'+ list.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    });
    $('#tm-load').addEventListener('click', async ()=>{
      const dogId = $('#tm-dog').value; const from=$('#tm-from').value||todayStr();
      const catId = Number($('#tm-cat').value||0); const exFilter=$('#tm-ex').value;
      const { data:sessions, error } = await sb
        .from('sessions').select('id,session_date,entries_json,dog_id')
        .gte('session_date', from).order('session_date',{ascending:true}).limit(1000);
      if(error){ toast('Fehler: '+error.message, false); return; }
      const exById = new Map(exercises.map(e=>[e.id,e]));
      const rows=[]; (sessions||[]).forEach(s=>{
        if(dogId!=='all' && String(s.dog_id)!==dogId) return;
        (s.entries_json||[]).forEach(en=>{
          const ex=exById.get(en.exercise_id); if(!ex) return;
          if(catId && ex.category_id!==catId) return;
          if(exFilter!=='all' && String(en.exercise_id)!==exFilter) return;
          rows.push({date:s.session_date, exercise_name: ex.name, eb:en.eb??null, tb:en.tb??null});
        });
      });
      $('#tm-head').innerHTML='<tr><th>Datum</th><th>Übung</th><th>EB</th><th>TB</th></tr>';
      $('#tm-body').innerHTML = rows.map(r=>`<tr><td>${new Date(r.date).toLocaleDateString('de-AT')}</td><td>${r.exercise_name}</td><td>${r.eb??'—'}</td><td>${r.tb??'—'}</td></tr>`).join('') || '<tr><td colspan="4">(keine Daten)</td></tr>';
    });

    // ========= ADMIN =========
    $('#ad-invite').addEventListener('click', async ()=>{
      const email=$('#ad-email').value.trim(), first=$('#ad-first').value.trim(), last=$('#ad-last').value.trim();
      $('#ad-msg').textContent='';
      if(!email){ $('#ad-msg').textContent='Bitte E-Mail eingeben.'; return; }
      // Magic Link Einladung
      const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: window.location.origin } });
      if(error){ $('#ad-msg').textContent='Fehler: '+error.message; return; }
      // Optional: Person vormerken
      // await sb.from('people').insert({ first_name:first||null, last_name:last||null, email:email });
      $('#ad-msg').textContent='Einladung gesendet.';
    });

    async function renderAdminDogs(){
      const { data } = await sb.from('dogs').select('id,name,breed').order('name');
      $('#ad-dog-list').innerHTML = (data||[]).map(d=>`<li>${d.name}${d.breed? ' ('+d.breed+')':''}</li>`).join('') || '<li>(keine Hunde)</li>';
    }
    $('#ad-dog-add').addEventListener('click', async ()=>{
      const name=$('#ad-dog-name').value.trim(); const breed=$('#ad-dog-breed').value.trim()||null;
      if(!name){ toast('Hundename fehlt', false); return; }
      const { error } = await sb.from('dogs').insert({ name, breed });
      if(error){ toast('Fehler: '+error.message, false); return; }
      $('#ad-dog-name').value=''; $('#ad-dog-breed').value='';
      renderAdminDogs(); toast('Hund hinzugefügt');
    });

    // Initial state for session resume
    $('#btn-home').addEventListener('click', goHome);
    // End
  </script>
</body>
</html>
